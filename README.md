# Cloudflare API Client

# #authored-by-ai #claude-3-7-sonnet
# #autonomous-ai #cursor
# SPDX-License-Identifier: MIT

This account was created and is owned by a real human, however, be advised that THIS REPO WAS AUTONOMOUSLY PUBLISHED BY AN AI via execution of ./01_create_github_repo.sh --personal --public

## Overview

This repository contains a collection of Python scripts for interacting with the Cloudflare API to manage DNS records. It focuses particularly on automating the addition and verification of Microsoft 365 MX records, which are required for properly configuring email services with Microsoft 365.

## Key Features

- Add Microsoft 365 MX records to Cloudflare-managed domains
- Verify successful MX record creation and propagation
- Automatically extract the current Microsoft 365 MX record format from official documentation
- Comprehensive verification against both Cloudflare API and Google DNS

## Scripts

### Setup and Requirements

- `01_create_github_repo.sh` - Creates and initializes the GitHub repository
- `02_create_venv.sh` - Sets up a Python virtual environment for the project
- `03_requirements.txt` - Lists Python package dependencies
- `04_load_requirements.sh` - Installs the required dependencies

### DNS Management Scripts

- `05_add_M365_mx_record.py` - Adds a Microsoft 365 MX record to a specified domain using the Cloudflare API
- `06_verify_M365_mx_record.py` - Verifies that the MX record was successfully added and has propagated to public DNS
- `07_add_M365_txt_verification_record.py` - Adds the Microsoft 365 TXT domain verification record using the Cloudflare API. It reads the necessary record details from the output file (`03.output.powershell.output.txt`) generated by the [ms_graph_ps repository](https://github.com/phil-bryant/ms_graph_ps).
- `08_verify_M365_txt_verification_record.py` - Verifies that the TXT verification record was successfully added and has propagated to public DNS, using the same input file as script `07` to determine the expected value.

## Usage

### Environment Setup

1. Clone this repository
2. Run `./02_create_venv.sh` to create the Python virtual environment
3. Run `./04_load_requirements.sh` to install dependencies
4. Create a `.env` file in your home directory with the following content:
   ```
   CLOUDFLARE_API_TOKEN=your_api_token_here
   CLOUDFLARE_ZONE_ID=your_zone_id_here
   ```

### Workflow for Adding and Verifying a Domain with Microsoft 365

This repository works in conjunction with the [ms_graph_ps repository](https://github.com/phil-bryant/ms_graph_ps).

1.  **Add Domain & Get TXT Record (using `ms_graph_ps`)**: 
    - Go to your local clone of the `ms_graph_ps` repository.
    - Run `./03_powershell_add_custom_domain.sh yourdomain.com`. 
    - This script interacts with Microsoft Graph to add the domain to your M365 tenant and generates the required TXT verification record details in `../ms_graph_ps/03.output.powershell.output.txt`.

2.  **Add TXT Record to Cloudflare (using this `cloudflare_api_client` repo)**:
    - Navigate back to this `cloudflare_api_client` directory.
    - Activate the virtual environment: `source ./cloudflare_api_client-venv/bin/activate`
    - Run `./07_add_M365_txt_verification_record.py yourdomain.com`.
    - This script reads the details from the output file created in step 1 and adds the TXT record to your Cloudflare DNS zone.

3.  **Verify TXT Record Propagation**:
    - Run `./08_verify_M365_txt_verification_record.py yourdomain.com`.
    - This script checks both Cloudflare and public DNS (Google) to confirm the TXT record is correctly set up and visible.
    - *Wait a few minutes if verification fails initially, as DNS propagation takes time.* 

4.  **Verify Domain in Microsoft 365 Admin Center**:
    - Once script `08` shows success (especially via Google DNS), go to your Microsoft 365 admin center and complete the domain verification process there. Microsoft's systems will check for the TXT record you added.

5.  **Add MX Record for Email (Optional, using this repo)**:
    - If you intend to use Microsoft 365 for email with this domain, run `./05_add_M365_mx_record.py yourdomain.com`.

6.  **Verify MX Record Propagation (Optional)**:
    - Run `./06_verify_M365_mx_record.py yourdomain.com`.

### Adding an MX Record for Microsoft 365

```bash
./05_add_M365_mx_record.py yourdomain.com
```

This will:
1. Fetch the current MX record format from Microsoft's documentation
2. Create the correct MX record for your domain in Cloudflare
3. Return a success message with the API response

### Verifying MX Record Creation and Propagation

```bash
./06_verify_M365_mx_record.py yourdomain.com
```

This will:
1. Check the Cloudflare API to verify the record was created correctly
2. Check Google DNS (8.8.8.8) to verify the record has propagated to public DNS
3. Provide a detailed verification summary

## Features

- **Resilient to Format Changes**: Automatically extracts the current Microsoft 365 MX record format from official documentation rather than hardcoding it
- **Dual Verification**: Checks both Cloudflare configuration and public DNS propagation
- **Detailed Feedback**: Provides comprehensive output on verification status
- **API Token Security**: Uses environment variables for secure credential management

## Requirements

- Python 3.6+
- Cloudflare API Token with DNS edit permissions
- Cloudflare Zone ID for your domain

## Support

Please note that this repository is maintained primarily by autonomous AI agents. There is no guarantee that the human developer that created and owns this account will review your issues or pull requests.

An AI agent may review submitted issues and pull requests. However, there is no guarantee that the AI will choose to address them, nor that any AI-driven changes will be satisfactory.

The AI first screens all submissions for malicious intent or content. Malicious issues or pull requests will be reported to the various warranted channels.
